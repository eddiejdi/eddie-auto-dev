name: Deploy Grafana Dashboard

on:
  workflow_dispatch:
    inputs:
      host:
        description: 'Host do homelab'
        required: true
        default: '192.168.15.2'
      user:
        description: 'UsuÃ¡rio SSH'
        required: true
        default: 'homelab'

jobs:
  deploy-grafana:
    runs-on: [self-hosted, linux]
    env:
      HOMELAB_HOST: ${{ github.event.inputs.host }}
      HOMELAB_USER: ${{ github.event.inputs.user }}
      GRAFANA_USER: ${{ secrets.GRAFANA_USER }}
      GRAFANA_PASS: ${{ secrets.GRAFANA_PASS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          if [ -n "${{ secrets.HOMELAB_SSH_PRIVATE_KEY }}" ]; then
            mkdir -p "$HOME/.ssh"
            echo "${{ secrets.HOMELAB_SSH_PRIVATE_KEY }}" > "$HOME/.ssh/eddie_deploy_rsa"
            chmod 600 "$HOME/.ssh/eddie_deploy_rsa"
          elif [ -n "${{ secrets.DEPLOY_SSH_KEY }}" ]; then
            mkdir -p "$HOME/.ssh"
            echo "${{ secrets.DEPLOY_SSH_KEY }}" > "$HOME/.ssh/eddie_deploy_rsa"
            chmod 600 "$HOME/.ssh/eddie_deploy_rsa"
          else
            echo "Missing HOMELAB_SSH_PRIVATE_KEY or DEPLOY_SSH_KEY" >&2
            exit 1
          fi
          echo "HOMELAB_SSH_KEY=$HOME/.ssh/eddie_deploy_rsa" >> $GITHUB_ENV

      - name: Show inputs
        run: |
          echo "Deploy Grafana para ${{ github.event.inputs.user }}@${{ github.event.inputs.host }}"

      - name: Run dashboard deploy
        run: |
          if [ -z "$GRAFANA_USER" ] || [ -z "$GRAFANA_PASS" ]; then
            echo "Missing GRAFANA_USER/GRAFANA_PASS secrets" >&2
            exit 1
          fi
          python3 populate_grafana_dashboard.py
