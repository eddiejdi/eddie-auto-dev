name: Deploy Auto-Developed Solution

on:
  push:
    branches:
      - main
    paths:
      - 'solutions/**'
  workflow_dispatch:
    inputs:
      solution_id:
        description: 'ID da solu√ß√£o para deploy (opcional)'
        required: false
        type: string

env:
  DEPLOY_USER: homelab
  DEPLOY_HOST: 192.168.15.2
  DEPLOY_PATH: /home/homelab/deployed_solutions

jobs:
  deploy:
    name: Deploy Solu√ß√µes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Verificar se h√° solu√ß√µes
        id: check
        run: |
          if [ -d "solutions" ] && [ "$(ls -A solutions 2>/dev/null)" ]; then
            echo "has_solutions=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Solu√ß√µes encontradas para deploy"
          else
            echo "has_solutions=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Nenhuma solu√ß√£o para deploy"
          fi
      
      - name: Configurar SSH
        if: steps.check.outputs.has_solutions == 'true'
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
      
      - name: Adicionar host conhecido
        if: steps.check.outputs.has_solutions == 'true'
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || echo "Host scan falhou, continuando..."
      
      - name: Deploy para servidor
        if: steps.check.outputs.has_solutions == 'true'
        run: |
          # Criar diret√≥rio remoto
          ssh -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} \
            "mkdir -p ${{ env.DEPLOY_PATH }}" || true
          
          # Sincronizar solu√ß√µes
          rsync -avz --progress \
            solutions/ \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/ || \
            echo "‚ö†Ô∏è rsync falhou, tentando scp..."
          
          # Executar scripts de deploy
          ssh -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} \
            "cd ${{ env.DEPLOY_PATH }} && find . -name 'deploy.sh' -exec chmod +x {} \; -exec bash {} \; 2>/dev/null" || true
          
          echo "‚úÖ Deploy conclu√≠do!"
      
      - name: Notificar Telegram
        if: always() && steps.check.outputs.has_solutions == 'true'
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" == "success" ]; then
            EMOJI="‚úÖ"
            MSG="Deploy conclu√≠do com sucesso!"
          else
            EMOJI="‚ùå"
            MSG="Deploy falhou!"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=Markdown" \
            -d "text=${EMOJI} *Auto-Dev Deploy*%0A%0A${MSG}%0A%0Aüìã Commit: \`${{ github.sha }}\`%0Aüîó [Ver a√ß√£o](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
            || echo "Notifica√ß√£o Telegram falhou"
