name: Deploy Auto-Developed Solution

on:
  push:
    branches:
      - main
    paths:
      - 'solutions/**'
  workflow_dispatch:
    inputs:
      solution_id:
        description: 'ID da solu√ß√£o para deploy (opcional)'
        required: false
        type: string

# NOTA: Deploy SSH √© feito localmente pelo bot (192.168.15.2 n√£o √© acess√≠vel do GitHub)
# Este workflow apenas valida e notifica

jobs:
  notify:
    name: Validar e Notificar
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Verificar solu√ß√µes
        id: check
        run: |
          if [ -d "solutions" ] && [ "$(ls -A solutions 2>/dev/null)" ]; then
            echo "has_solutions=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Solu√ß√µes encontradas:"
            ls -la solutions/
          else
            echo "has_solutions=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Nenhuma solu√ß√£o nova"
          fi
      
      - name: Log solu√ß√µes detectadas
        if: steps.check.outputs.has_solutions == 'true'
        run: |
          echo "üì¶ Solu√ß√µes encontradas - deploy ser√° feito localmente pelo bot"
          echo "‚ÑπÔ∏è O servidor 192.168.15.2 n√£o √© acess√≠vel do GitHub Actions"
          echo "‚úÖ O Telegram Bot executa deploy via systemd timer local"
      
      - name: Notificar Telegram
        if: always() && steps.check.outputs.has_solutions == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "‚ö†Ô∏è Telegram secrets n√£o configurados, pulando notifica√ß√£o"
            exit 0
          fi
          
          STATUS="${{ job.status }}"
          if [ "$STATUS" == "success" ]; then
            EMOJI="‚úÖ"
            MSG="C√≥digo validado! Deploy ser√° feito localmente."
          else
            EMOJI="‚ùå"
            MSG="Valida√ß√£o falhou!"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "parse_mode=Markdown" \
            -d "text=${EMOJI} *Auto-Dev Deploy*%0A%0A${MSG}%0A%0Aüìã Commit: \`${{ github.sha }}\`%0Aüîó [Ver a√ß√£o](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
            || echo "Notifica√ß√£o Telegram falhou"
