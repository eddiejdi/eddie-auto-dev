name: Deploy Auto-Developed Solution

on:
  push:
    branches:
      - main
    paths:
      - 'solutions/**'
  workflow_dispatch:
    inputs:
      solution_id:
        description: 'ID da solu√ß√£o para deploy (opcional)'
        required: false
        type: string

# NOTA: Deploy SSH √© feito localmente pelo bot (192.168.15.2 n√£o √© acess√≠vel do GitHub)
# Este workflow apenas valida e notifica

jobs:
  notify:
    name: Validar e Notificar
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Verificar solu√ß√µes
        id: check
        run: |
          if [ -d "solutions" ] && [ "$(ls -A solutions 2>/dev/null)" ]; then
            echo "has_solutions=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Solu√ß√µes encontradas:"
            ls -la solutions/
          else
            echo "has_solutions=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Nenhuma solu√ß√£o nova"
          fi
      
      - name: Notificar Telegram
        if: steps.check.outputs.has_solutions == 'true'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=Markdown" \
            -d "text=üì¶ *CI - Solu√ß√£o Registrada*%0A%0A‚úÖ C√≥digo commitado no GitHub%0Aüè† Deploy executado localmente pelo bot%0A%0Aüìã Commit: \`${{ github.sha }}\`%0Aüîó [Ver a√ß√£o](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
            || echo "Notifica√ß√£o Telegram falhou"
          # Executar scripts de deploy
          ssh -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} \
            "cd ${{ env.DEPLOY_PATH }} && find . -name 'deploy.sh' -exec chmod +x {} \; -exec bash {} \; 2>/dev/null" || true
          
          echo "‚úÖ Deploy conclu√≠do!"
      
      - name: Notificar Telegram
        if: always() && steps.check.outputs.has_solutions == 'true'
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" == "success" ]; then
            EMOJI="‚úÖ"
            MSG="Deploy conclu√≠do com sucesso!"
          else
            EMOJI="‚ùå"
            MSG="Deploy falhou!"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=Markdown" \
            -d "text=${EMOJI} *Auto-Dev Deploy*%0A%0A${MSG}%0A%0Aüìã Commit: \`${{ github.sha }}\`%0Aüîó [Ver a√ß√£o](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
            || echo "Notifica√ß√£o Telegram falhou"
