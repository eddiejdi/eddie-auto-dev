name: Deploy to Homelab
true:
  pull_request:
    types:
    - labeled
  issues:
    types:
    - labeled
  workflow_dispatch: null
jobs:
  detect_selfhost:
    runs-on: ubuntu-latest
    outputs:
      available: ${{ steps.check.outputs.available }}
    steps:
    - name: Check for self-hosted runners
      id: check
      run: "set -e\nREPO=${{ github.repository }}\necho \"Checking self-hosted runners\
        \ for repo $REPO\"\nCURL=\"curl -s -H 'Accept: application/vnd.github+json'\
        \ -H 'Authorization: token ${{ secrets.GITHUB_TOKEN }}' https://api.github.com/repos/$REPO/actions/runners\"\
        \necho \"Running: $CURL\"\nRESP=$(eval $CURL)\necho \"$RESP\" > runners.json\n\
        # Use jq to find any runner with label homelab or self-hosted\nMATCH=$(echo\
        \ \"$RESP\" | jq '.runners[] | select(.labels[].name==\"homelab\" or .labels[].name==\"\
        self-hosted\")' || true)\nif [ -n \"$MATCH\" ]; then\n  echo \"available=true\"\
        \ >> $GITHUB_OUTPUT\nelse\n  # If this is a pull_request event, see if PR\
        \ has label 'force-selfhost'\n  if [ \"$GITHUB_EVENT_NAME\" = \"pull_request\"\
        \ ]; then\n    LABELS=$(jq -r '.pull_request.labels[].name' \"$GITHUB_EVENT_PATH\"\
        \ 2>/dev/null || true)\n    if echo \"$LABELS\" | grep -q \"force-selfhost\"\
        ; then\n      echo \"available=true\" >> $GITHUB_OUTPUT\n    else\n      echo\
        \ \"available=false\" >> $GITHUB_OUTPUT\n    fi\n  else\n    echo \"available=false\"\
        \ >> $GITHUB_OUTPUT\n  fi\nfi\n"
  deploy-selfhost:
    needs: detect_selfhost
    if: needs.detect_selfhost.outputs.available == 'true' && ((github.event_name ==
      'pull_request' && (contains(join(' ', github.event.pull_request.labels.*.name),
      'deploy') || github.event.label.name == 'deploy')) || github.event_name == 'workflow_dispatch'
      || startsWith(github.ref, 'refs/heads/feat/remote-orchestrator'))
    runs-on:
    - self-hosted
    - linux
    timeout-minutes: 5
    steps:
    - uses: actions/checkout@v4
    - name: Show runner info
      run: 'echo "Running on self-hosted runner: $(hostname)"

        '
    - name: Run deploy locally on self-hosted runner
      run: 'set -e

        echo "Executing deploy on self-hosted runner (local execution)"

        cd ~/eddie-auto-dev || exit 1

        git fetch --all || true

        git checkout main || true

        git pull || true

        ./deploy_prod.sh || exit 1

        '
  deploy:
    needs: deploy-selfhost
    if: needs.deploy-selfhost.result != 'success' && ((github.event_name == 'pull_request'
      && (contains(join(' ', github.event.pull_request.labels.*.name), 'deploy') ||
      github.event.label.name == 'deploy')) || github.event_name == 'workflow_dispatch'
      || startsWith(github.ref, 'refs/heads/feat/remote-orchestrator'))
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Debug event & secrets
      run: 'set -e

        echo "GITHUB_EVENT_NAME=$GITHUB_EVENT_NAME"

        echo "Event payload (label or issue):"

        jq -r ''.label.name // .issue.label.name // "<no label>"'' "$GITHUB_EVENT_PATH"
        2>/dev/null || true

        # Print which ssh secrets are set (do not print the secret values)

        if [ -n "${{ secrets.HOMELAB_SSH_PRIVATE_KEY }}" ]; then echo "HOMELAB_SSH_PRIVATE_KEY=SET";
        else echo "HOMELAB_SSH_PRIVATE_KEY=EMPTY"; fi

        if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then echo "SSH_PRIVATE_KEY=SET";
        else echo "SSH_PRIVATE_KEY=EMPTY"; fi

        if [ -n "${{ secrets.DEPLOY_SSH_KEY }}" ]; then echo "DEPLOY_SSH_KEY=SET";
        else echo "DEPLOY_SSH_KEY=EMPTY"; fi

        '
    - name: Setup SSH key (use available secret)
      run: "set -e\nmkdir -p ~/.ssh\n# Choose available secret for SSH key\nif [ -n\
        \ \"${{ secrets.HOMELAB_SSH_PRIVATE_KEY }}\" ]; then\n  echo \"${{ secrets.HOMELAB_SSH_PRIVATE_KEY\
        \ }}\" > ~/.ssh/id_rsa\nelif [ -n \"${{ secrets.SSH_PRIVATE_KEY }}\" ]; then\n\
        \  echo \"${{ secrets.SSH_PRIVATE_KEY }}\" > ~/.ssh/id_rsa\nelif [ -n \"${{\
        \ secrets.DEPLOY_SSH_KEY }}\" ]; then\n  echo \"${{ secrets.DEPLOY_SSH_KEY\
        \ }}\" > ~/.ssh/id_rsa\nelse\n  echo \"No SSH key secret found (HOMELAB_SSH_PRIVATE_KEY,\
        \ SSH_PRIVATE_KEY or DEPLOY_SSH_KEY).\" >&2\n  exit 1\nfi\nchmod 600 ~/.ssh/id_rsa\n\
        # known hosts if provided\nif [ -n \"${{ secrets.HOMELAB_HOST }}\" ]; then\n\
        \  ssh-keyscan -H ${{ secrets.HOMELAB_HOST }} >> ~/.ssh/known_hosts || true\n\
        fi\n"
    - name: Deploy to homelab (with retry)
      env:
        HOMELAB_USER: ${{ secrets.HOMELAB_USER }}
        HOMELAB_HOST: ${{ secrets.HOMELAB_HOST }}
      run: "set -e\nTARGET_HOST=${{ secrets.HOMELAB_HOST }}\nif [ -z \"$TARGET_HOST\"\
        \ ]; then\n  echo \"HOMELAB_HOST secret not set. Use repo secrets to define\
        \ host.\" >&2\n  exit 1\nfi\n\n# Prevent attempts from GitHub-hosted runners\
        \ to private network hosts\nif echo \"$TARGET_HOST\" | grep -E \"^(10\\.|192\\\
        .168\\.|172\\.(1[6-9]|2[0-9]|3[0-1])\\.)\" >/dev/null; then\n  echo \"HOMELAB_HOST\
        \ appears to be a private IP ($TARGET_HOST). GitHub hosted runners cannot\
        \ reach private networks.\"\n  echo \"Recommended: install a self-hosted runner\
        \ on your homelab and run the 'Deploy to Homelab (Self-hosted)' workflow (Actions\
        \ -> Deploy to Homelab (Self-hosted)).\" >&2\n  echo \"See docs/DEPLOY_TO_HOMELAB.md\
        \ and tools/deploy/setup_self_hosted_runner.sh for installation instructions.\"\
        \ >&2\n  exit 1\nfi\n\necho \"Deploying to $HOMELAB_USER@$TARGET_HOST\"\n\n\
        ATTEMPTS=3\nfor i in $(seq 1 $ATTEMPTS); do\n  echo \"Attempt $i of $ATTEMPTS\"\
        \n  ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no $HOMELAB_USER@$TARGET_HOST\
        \ \"cd ~/eddie-auto-dev && git fetch --all && git checkout main && git pull\
        \ && ./deploy_prod.sh\"\n  if [ $? -eq 0 ]; then\n    echo \"Deploy succeeded\"\
        \n    exit 0\n  fi\n  sleep $((i * 5))\ndone\necho \"All attempts failed\"\
        \ >&2\nexit 1\n"
  selenium-e2e:
    name: Selenium E2E
    uses: ./.github/workflows/selenium-tests.yml
