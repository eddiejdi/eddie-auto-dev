name: Deploy to Homelab

on:
  pull_request:
    types: [labeled]
  issues:
    types: [labeled]
  workflow_dispatch:

jobs:
  deploy-selfhost:
    # Try to run deploy on a self-hosted runner first (short timeout)
    if: (github.event_name == 'pull_request' && (contains(join(' ', github.event.pull_request.labels.*.name), 'deploy') || github.event.label.name == 'deploy')) || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/heads/feat/remote-orchestrator')
    runs-on: [self-hosted, linux]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Show runner info
        run: |
          echo "Running on self-hosted runner: $(hostname)"
      - name: Run deploy locally on self-hosted runner
        run: |
          set -e
          USER=${{ github.event.inputs.user || secrets.HOMELAB_USER || 'homelab' }}
          HOST=${{ github.event.inputs.host || secrets.HOMELAB_HOST || 'localhost' }}
          echo "Executing deploy on self-hosted runner (local execution)"
          # Execute locally on the runner (no SSH) for safety: pull and run deploy script
          cd ~/eddie-auto-dev || exit 1
          git fetch --all || true
          git checkout main || true
          git pull || true
          ./deploy_prod.sh || exit 1

  deploy:
    needs: deploy-selfhost
    # Run only if self-hosted did not succeed
    if: needs.deploy-selfhost.result != 'success' && ((github.event_name == 'pull_request' && (contains(join(' ', github.event.pull_request.labels.*.name), 'deploy') || github.event.label.name == 'deploy')) || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/heads/feat/remote-orchestrator'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Debug event & secrets
        run: |
          set -e
          echo "GITHUB_EVENT_NAME=$GITHUB_EVENT_NAME"
          echo "Event payload (label or issue):"
          jq -r '.label.name // .issue.label.name // "<no label>"' "$GITHUB_EVENT_PATH" 2>/dev/null || true
          # Print which ssh secrets are set (do not print the secret values)
          if [ -n "${{ secrets.HOMELAB_SSH_PRIVATE_KEY }}" ]; then echo "HOMELAB_SSH_PRIVATE_KEY=SET"; else echo "HOMELAB_SSH_PRIVATE_KEY=EMPTY"; fi
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then echo "SSH_PRIVATE_KEY=SET"; else echo "SSH_PRIVATE_KEY=EMPTY"; fi
          if [ -n "${{ secrets.DEPLOY_SSH_KEY }}" ]; then echo "DEPLOY_SSH_KEY=SET"; else echo "DEPLOY_SSH_KEY=EMPTY"; fi

      - name: Setup SSH key (use available secret)
        run: |
          set -e
          mkdir -p ~/.ssh
          # Choose available secret for SSH key
          if [ -n "${{ secrets.HOMELAB_SSH_PRIVATE_KEY }}" ]; then
            echo "${{ secrets.HOMELAB_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          elif [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          elif [ -n "${{ secrets.DEPLOY_SSH_KEY }}" ]; then
            echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
          else
            echo "No SSH key secret found (HOMELAB_SSH_PRIVATE_KEY, SSH_PRIVATE_KEY or DEPLOY_SSH_KEY)." >&2
            exit 1
          fi
          chmod 600 ~/.ssh/id_rsa
          # known hosts if provided
          if [ -n "${{ secrets.HOMELAB_HOST }}" ]; then
            ssh-keyscan -H ${{ secrets.HOMELAB_HOST }} >> ~/.ssh/known_hosts || true
          fi

      - name: Deploy to homelab (with retry)
        env:
          HOMELAB_USER: ${{ secrets.HOMELAB_USER }}
          HOMELAB_HOST: ${{ secrets.HOMELAB_HOST }}
        run: |
          set -e
          TARGET_HOST=${{ secrets.HOMELAB_HOST }}
          if [ -z "$TARGET_HOST" ]; then
            echo "HOMELAB_HOST secret not set. Use repo secrets to define host." >&2
            exit 1
          fi

          # Prevent attempts from GitHub-hosted runners to private network hosts
          if echo "$TARGET_HOST" | grep -E "^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1])\.)" >/dev/null; then
            echo "HOMELAB_HOST appears to be a private IP ($TARGET_HOST). GitHub hosted runners cannot reach private networks."
            echo "Recommended: install a self-hosted runner on your homelab and run the 'Deploy to Homelab (Self-hosted)' workflow (Actions -> Deploy to Homelab (Self-hosted))." >&2
            echo "See docs/DEPLOY_TO_HOMELAB.md and tools/deploy/setup_self_hosted_runner.sh for installation instructions." >&2
            exit 1
          fi

          echo "Deploying to $HOMELAB_USER@$TARGET_HOST"

          ATTEMPTS=3
          for i in $(seq 1 $ATTEMPTS); do
            echo "Attempt $i of $ATTEMPTS"
            ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no $HOMELAB_USER@$TARGET_HOST "cd ~/eddie-auto-dev && git fetch --all && git checkout main && git pull && ./deploy_prod.sh"
            if [ $? -eq 0 ]; then
              echo "Deploy succeeded"
              exit 0
            fi
            sleep $((i * 5))
          done
          echo "All attempts failed" >&2
          exit 1
