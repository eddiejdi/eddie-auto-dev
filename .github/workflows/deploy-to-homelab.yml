name: Deploy to Homelab
on:
  pull_request:
    types:
      - labeled
  issues:
    types:
      - labeled
  workflow_dispatch:

jobs:
  detect_selfhost:
    runs-on: ubuntu-latest
    outputs:
      available: ${{ steps.check.outputs.available }}
    steps:
    - name: Check for self-hosted runners
      id: check
      run: |
        set -e
        REPO="${{ github.repository }}"
        echo "Checking self-hosted runners for repo $REPO"
        
        # Fetch runners JSON
        RESP=$(curl -s -H 'Accept: application/vnd.github+json' \
          -H 'Authorization: token ${{ secrets.GITHUB_TOKEN }}' \
          https://api.github.com/repos/$REPO/actions/runners)
        
        # Debug: print response summary
        echo "Response: $(echo "$RESP" | jq '.runners | length') runners"
        
        # Check if any runner has label 'homelab' (case-insensitive match)
        FOUND=$(echo "$RESP" | jq -r '.runners[].labels[].name' 2>/dev/null | grep -i "homelab" || true)
        
        if [ -n "$FOUND" ]; then
          echo "Found homelab runner: $FOUND"
          echo "available=true" >> $GITHUB_OUTPUT
        else
          echo "No homelab runner found"
          # If this is a workflow_dispatch, force it to true
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Forcing available=true for workflow_dispatch"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
          fi
        fi

  deploy-selfhost:
    needs: detect_selfhost
    if: needs.detect_selfhost.outputs.available == 'true' && ((github.event_name ==
      'pull_request' && (contains(join(' ', github.event.pull_request.labels.*.name),
      'deploy') || github.event.label.name == 'deploy')) || github.event_name == 'workflow_dispatch'
      || startsWith(github.ref, 'refs/heads/feat/remote-orchestrator'))
    runs-on:
      - self-hosted
      - linux
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Show runner info
        run: |
          echo "Running on self-hosted runner: $(hostname)"
      - name: (Optional) Install RCA scripts and services
        env:
          INSTALL_RCA_SERVICES: ${{ secrets.INSTALL_RCA_SERVICES }}
        run: |
          set -e
          if [ "${INSTALL_RCA_SERVICES:-}" != "1" ]; then
            echo "Skipping RCA install (INSTALL_RCA_SERVICES not set to 1)"
            exit 0
          fi
          echo "Installing RCA scripts to $HOME/eddie-auto-dev/tools/homelab_recovery"
          mkdir -p $HOME/eddie-auto-dev/tools/homelab_recovery
          cp -r tools/homelab_recovery/* $HOME/eddie-auto-dev/tools/homelab_recovery/ || true
          cp -f tools/agent_api_client.py $HOME/eddie-auto-dev/tools/ || true
          mkdir -p $HOME/.config/systemd/user
          {
            echo "[Unit]"
            echo "Description=Agent RCA API (user)"
            echo "After=network.target"
            echo ""
            echo "[Service]"
            echo "Type=simple"
            echo "ExecStart=/usr/bin/env python3 \$HOME/eddie-auto-dev/tools/homelab_recovery/simple_agent_api.py"
            echo "Restart=on-failure"
            echo "RestartSec=3"
            echo "StandardOutput=append:/tmp/agent-api.service.log"
            echo "StandardError=append:/tmp/agent-api.service.err"
            echo ""
            echo "[Install]"
            echo "WantedBy=default.target"
          } > "$HOME/.config/systemd/user/agent-api.service"
          {
            echo "[Unit]"
            echo "Description=Agent Consumer (user) - process RCAs from /tmp/agent_queue"
            echo "After=network.target"
            echo ""
            echo "[Service]"
            echo "Type=simple"
            echo "ExecStart=/usr/bin/env python3 \$HOME/eddie-auto-dev/tools/homelab_recovery/agent_consumer_loop.py"
            echo "Restart=always"
            echo "RestartSec=5"
            echo "StandardOutput=append:/tmp/agent-consumer.service.log"
            echo "StandardError=append:/tmp/agent-consumer.service.err"
            echo ""
            echo "[Install]"
            echo "WantedBy=default.target"
          } > "$HOME/.config/systemd/user/agent-consumer.service"
          systemctl --user daemon-reload || true
          systemctl --user enable --now agent-api.service || true
          systemctl --user enable --now agent-consumer.service || true
      - name: Run deploy locally on self-hosted runner
        run: |
          set -e

          echo "Executing deploy on self-hosted runner (local execution)"

          cd ~/eddie-auto-dev || exit 1

          git fetch --all || true

          git checkout main || true

          git pull || true

          ./deploy_prod.sh || exit 1

  deploy:
    needs: deploy-selfhost
    if: needs.deploy-selfhost.result != 'success' && ((github.event_name == 'pull_request'
      && (contains(join(' ', github.event.pull_request.labels.*.name), 'deploy') ||
      github.event.label.name == 'deploy')) || github.event_name == 'workflow_dispatch'
      || startsWith(github.ref, 'refs/heads/feat/remote-orchestrator'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Debug event & secrets
        run: |
          set -e

          echo "GITHUB_EVENT_NAME=$GITHUB_EVENT_NAME"

          echo "Event payload (label or issue):"

          jq -r '.label.name // .issue.label.name // "<no label>"' "$GITHUB_EVENT_PATH" 2>/dev/null || true

          if [ -n "${{ secrets.HOMELAB_SSH_PRIVATE_KEY }}" ]; then echo "HOMELAB_SSH_PRIVATE_KEY=SET"; else echo "HOMELAB_SSH_PRIVATE_KEY=EMPTY"; fi

          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then echo "SSH_PRIVATE_KEY=SET"; else echo "SSH_PRIVATE_KEY=EMPTY"; fi

          if [ -n "${{ secrets.DEPLOY_SSH_KEY }}" ]; then echo "DEPLOY_SSH_KEY=SET"; else echo "DEPLOY_SSH_KEY=EMPTY"; fi
      - name: Setup SSH key (use available secret)
        run: |
          set -e
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.HOMELAB_SSH_PRIVATE_KEY }}" ]; then
            echo "${{ secrets.HOMELAB_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          elif [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          elif [ -n "${{ secrets.DEPLOY_SSH_KEY }}" ]; then
            echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
          else
            echo "No SSH key secret found (HOMELAB_SSH_PRIVATE_KEY, SSH_PRIVATE_KEY or DEPLOY_SSH_KEY)." >&2
            exit 1
          fi
          chmod 600 ~/.ssh/id_rsa
          if [ -n "${{ secrets.HOMELAB_HOST }}" ]; then
            ssh-keyscan -H ${{ secrets.HOMELAB_HOST }} >> ~/.ssh/known_hosts || true
          fi
      - name: Deploy to homelab (with retry)
        env:
          HOMELAB_USER: ${{ secrets.HOMELAB_USER }}
          HOMELAB_HOST: ${{ secrets.HOMELAB_HOST }}
        run: |
          set -e
          TARGET_HOST=${{ secrets.HOMELAB_HOST }}
          if [ -z "$TARGET_HOST" ]; then
            echo "HOMELAB_HOST secret not set. Use repo secrets to define host." >&2
            exit 1
          fi
          if echo "$TARGET_HOST" | grep -E '^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1])\.)' >/dev/null; then
            echo "HOMELAB_HOST appears to be a private IP ($TARGET_HOST). GitHub hosted runners cannot reach private networks."
            echo "Recommended: install a self-hosted runner on your homelab and run the 'Deploy to Homelab (Self-hosted)' workflow (Actions -> Deploy to Homelab (Self-hosted))." >&2
            echo "See docs/DEPLOY_TO_HOMELAB.md and tools/deploy/setup_self_hosted_runner.sh for installation instructions." >&2
            exit 1
          fi
          echo "Deploying to $HOMELAB_USER@$TARGET_HOST"
          ATTEMPTS=3
          for i in $(seq 1 $ATTEMPTS); do
            echo "Attempt $i of $ATTEMPTS"
            ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no $HOMELAB_USER@$TARGET_HOST "cd ~/eddie-auto-dev && git fetch --all && git checkout main && git pull && ./deploy_prod.sh"
            if [ $? -eq 0 ]; then
              echo "Deploy succeeded"
              exit 0
            fi
            sleep $((i * 5))
          done
          echo "All attempts failed" >&2
          exit 1

  selenium-e2e:
    name: Selenium E2E
    uses: ./.github/workflows/selenium-tests.yml
