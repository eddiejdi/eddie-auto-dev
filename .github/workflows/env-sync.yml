name: Environment Sync Pipeline

on:
  workflow_dispatch:
    inputs:
      target:
        description: Ambiente para deploy (DEV|CER|HOM|PROD|ALL)
        required: false
        default: "ALL"

env:
  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

jobs:
  branch-guard:
    name: Branch guard
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.check.outputs.allowed }}
    steps:
      - name: Check branch
        id: check
        run: |
          echo "branch=${GITHUB_REF}"
          if [ "${GITHUB_REF}" != "refs/heads/main" ] && [ "${GITHUB_EVENT_NAME}" != "workflow_dispatch" ]; then
            echo "allowed=false" >> $GITHUB_OUTPUT
            echo "Skipping env-sync checks because not main and not manual dispatch: ${GITHUB_REF}"
            exit 0
          fi
          echo "allowed=true" >> $GITHUB_OUTPUT

  # ============ InfrastructureAnalyst: ValidaÃ§Ãµes de CÃ³digo ============
  checks:
    name: "[InfrastructureAnalyst] VerificaÃ§Ãµes"
    runs-on: ubuntu-latest
    needs: [branch-guard]
    if: ${{ needs.branch-guard.outputs.allowed == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Verificar sintaxe Python
        run: |
          find . -name "*.py" -type f ! -path "./.git/*" ! -path "./venv/*" ! -path "./backups/*" | head -50 | while read file; do
            python -m py_compile "$file" && echo "âœ… $file" || echo "âŒ $file"
          done
      - name: Verificar YAML
        run: |
          for f in .github/workflows/*.yml; do
            python -c "import yaml; yaml.safe_load(open('$f'))" && echo "âœ… $f" || echo "âŒ $f"
          done

  # ============ SREAgent: ValidaÃ§Ã£o de Endpoints ============
  sre-validation:
    name: "[SREAgent] Health Check Endpoints"
    runs-on: ubuntu-latest
    needs: checks
    if: ${{ github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Validar PROD
        id: prod-health
        run: |
          set -e
          HTTP_CODE=$(curl -s -o /tmp/prod_health.txt -w "%{http_code}" --max-time 10 http://192.168.15.2:3000/health || echo "000")
          echo "PROD Health: $HTTP_CODE" | tee /tmp/prod_health_summary.txt
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… PROD OK"
          else
            echo "âš ï¸ PROD nÃ£o disponÃ­vel"
          fi
        continue-on-error: true

      - name: Validar HOM
        id: hom-health
        run: |
          set -e
          HTTP_CODE=$(curl -s -o /tmp/hom_health.txt -w "%{http_code}" --max-time 10 http://192.168.15.2:3000/health || echo "000")
          echo "HOM Health: $HTTP_CODE" | tee /tmp/hom_health_summary.txt
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… HOM OK"
          else
            echo "âš ï¸ HOM nÃ£o disponÃ­vel"
          fi
        continue-on-error: true

      - name: Validar CER
        id: cer-health
        run: |
          set -e
          HTTP_CODE=$(curl -s -o /tmp/cer_health.txt -w "%{http_code}" --max-time 10 http://192.168.15.2:3000/health || echo "000")
          echo "CER Health: $HTTP_CODE" | tee /tmp/cer_health_summary.txt
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… CER OK"
          else
            echo "âš ï¸ CER nÃ£o disponÃ­vel"
          fi
        continue-on-error: true

      - name: Resumo SRE
        run: |
          echo "=============================================="
          echo "ðŸ“Š SRE Validation Report"
          echo "=============================================="
          echo "PROD: http://192.168.15.2:3000 - $(cat /tmp/prod_health_summary.txt 2>/dev/null || echo UNKNOWN)"
          echo "HOM:  http://192.168.15.2:3000 - $(cat /tmp/hom_health_summary.txt 2>/dev/null || echo UNKNOWN)"
          echo "CER:  http://192.168.15.2:3000 - $(cat /tmp/cer_health_summary.txt 2>/dev/null || echo UNKNOWN)"
          echo "=============================================="

      - name: Upload SRE health artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sre-health-logs
          path: |
            /tmp/prod_health.txt
            /tmp/prod_health_summary.txt
            /tmp/hom_health.txt
            /tmp/hom_health_summary.txt
            /tmp/cer_health.txt
            /tmp/cer_health_summary.txt

  # ============ DevOpsAgent: Deploy DEV ============
  deploy-dev:
    name: "[DevOpsAgent] Deploy DEV"
    runs-on: ubuntu-latest
    needs: [checks, sre-validation]
    # Executa deploy DEV quando em branch dev ou por dispatch explÃ­cito
    if: ${{ (github.ref == 'refs/heads/dev' || (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'DEV')) }}
    steps:
      - name: Configurar SSH
        run: |
          if [ -z "${{ secrets.DEPLOY_SSH_KEY }}" ]; then
            echo "No deploy SSH key set; skipping SSH configuration"
          else
            mkdir -p ~/.ssh
            echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            ssh-keyscan -H ${{ secrets.DEPLOY_HOST_DEV }} >> ~/.ssh/known_hosts 2>/dev/null || true
          fi
      - name: Deploy DEV via SSH
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ env.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST_DEV }} << 'DEPLOY_SCRIPT'
            set -e
            cd ${{ env.DEPLOY_PATH }}
            git fetch origin dev
            git reset --hard origin/dev
            sudo systemctl restart eddie-telegram-bot.service 2>/dev/null || true
            sudo systemctl restart specialized-agents.service 2>/dev/null || true
          DEPLOY_SCRIPT

  # ============ SREAgent: ValidaÃ§Ã£o PÃ³s-Deploy ============
  post-deploy-validation:
    name: "[SREAgent] Post-Deploy Validation"
    runs-on: ubuntu-latest
    needs: [deploy-sync]
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Aguardar propagaÃ§Ã£o
        run: sleep 30
      - name: Validar todos os endpoints pÃ³s-deploy
        run: |
          echo "=============================================="
          echo "ðŸ” SRE Post-Deploy Validation"
          echo "=============================================="
          FAILED=0
          
          # PROD
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://192.168.15.2:3000/health || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… PROD: OK ($HTTP_CODE)"
          else
            echo "âŒ PROD: FAILED ($HTTP_CODE)"
            FAILED=$((FAILED + 1))
          fi
          
          # HOM
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://192.168.15.2:3000/health || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… HOM: OK ($HTTP_CODE)"
          else
            echo "âŒ HOM: FAILED ($HTTP_CODE)"
            FAILED=$((FAILED + 1))
          fi
          
          # CER
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://192.168.15.2:3000/health || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… CER: OK ($HTTP_CODE)"
          else
            echo "âŒ CER: FAILED ($HTTP_CODE)"
            FAILED=$((FAILED + 1))
          fi
          
          echo "=============================================="
          if [ $FAILED -gt 0 ]; then
            echo "âš ï¸ $FAILED ambiente(s) com problemas"
          else
            echo "âœ… Todos os ambientes saudÃ¡veis"
          fi
          echo "=============================================="

  # ============ DevOpsAgent: Deploy CER/HOM/PROD ============
  deploy-sync:
    name: "[DevOpsAgent] Deploy ${{ matrix.env }}"
    runs-on: ubuntu-latest
    needs: [checks, sre-validation]
    # Executa deploy para CER/HOM/PROD quando em main ou por dispatch explÃ­cito
    if: ${{ (github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.target == 'ALL' || github.event.inputs.target == 'CER' || github.event.inputs.target == 'HOM' || github.event.inputs.target == 'PROD'))) }}
    strategy:
      fail-fast: false
      matrix:
        env: [CER, HOM, PROD]
    steps:
      - name: Set host variable
        id: set-host
        run: |
          if [ "${{ matrix.env }}" = "CER" ]; then
            echo "host=${{ secrets.DEPLOY_HOST_CER }}" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.env }}" = "HOM" ]; then
            echo "host=${{ secrets.DEPLOY_HOST_HOM }}" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.env }}" = "PROD" ]; then
            echo "host=${{ secrets.DEPLOY_HOST_PROD }}" >> $GITHUB_OUTPUT
          fi
      - name: Configurar SSH
        if: (github.event_name == 'push' || github.event.inputs.target == 'ALL' || github.event.inputs.target == matrix.env)
        run: |
          if [ -z "${{ secrets.DEPLOY_SSH_KEY }}" ]; then
            echo "No deploy SSH key set; skipping SSH configuration"
          else
            mkdir -p ~/.ssh
            echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            ssh-keyscan -H ${{ steps.set-host.outputs.host }} >> ~/.ssh/known_hosts 2>/dev/null || true
          fi
      - name: Deploy ${{ matrix.env }} via SSH
        if: (github.event_name == 'push' || github.event.inputs.target == 'ALL' || github.event.inputs.target == matrix.env)
        run: |
          if [ -z "${{ steps.set-host.outputs.host }}" ]; then
            echo "No host configured for ${{ matrix.env }}; skipping remote deploy step"
            exit 0
          fi
          if [ -z "${{ secrets.DEPLOY_SSH_KEY }}" ]; then
            echo "No deploy SSH key set; skipping remote deploy step"
            exit 0
          fi
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ env.DEPLOY_USER }}@${{ steps.set-host.outputs.host }} << 'DEPLOY_SCRIPT'
            set -e
            cd ${{ env.DEPLOY_PATH }}
            git fetch origin main
            git reset --hard origin/main
            sudo systemctl restart eddie-telegram-bot.service 2>/dev/null || true
            sudo systemctl restart specialized-agents.service 2>/dev/null || true
          DEPLOY_SCRIPT
