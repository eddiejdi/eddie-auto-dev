name: Evoke Operation Agent on Failure
on:
  workflow_run:
    types:
    - completed
jobs:
  evoke-operation-agent:
    name: Evoke Operation Agent
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
    - name: Prepare payload and invoke operation agent
      env:
        OP_AGENT_ENDPOINT: ${{ secrets.OP_AGENT_ENDPOINT }}
        OP_AGENT_TOKEN: ${{ secrets.OP_AGENT_TOKEN }}
        OP_AGENT_CHAT_SESSION: ${{ secrets.OP_AGENT_CHAT_SESSION }}
      run: "set -euo pipefail\nif [ -z \"${OP_AGENT_ENDPOINT:-}\" ] || [ -z \"${OP_AGENT_TOKEN:-}\"\
        \ ]; then\n  echo \"Missing OP_AGENT_ENDPOINT or OP_AGENT_TOKEN secrets; aborting.\"\
        \n  exit 1\nfi\nrepo=\"${{ github.repository }}\"\nworkflow_name=\"${{ github.event.workflow_run.name\
        \ }}\"\nrun_id=\"${{ github.event.workflow_run.id }}\"\nbranch=\"${{ github.event.workflow_run.head_branch\
        \ }}\"\nsha=\"${{ github.event.workflow_run.head_sha }}\"\n# Chat session\
        \ ID can be provided via secret OP_AGENT_CHAT_SESSION\nchat_session=\"${OP_AGENT_CHAT_SESSION:-}\"\
        \n\npayload=$(printf '{\"repository\":\"%s\",\"workflow\":\"%s\",\"run_id\"\
        :\"%s\",\"branch\":\"%s\",\"sha\":\"%s\",\"chat_session\":\"%s\"}' \"$repo\"\
        \ \"$workflow_name\" \"$run_id\" \"$branch\" \"$sha\" \"$chat_session\")\n\
        \n# Debug: do not print secrets, but show which non-secret values are present\n\
        echo \"Repo: ${repo}\"\necho \"Workflow: ${workflow_name}\"\necho \"Run ID:\
        \ ${run_id}\"\necho \"Branch: ${branch}\"\necho \"SHA: ${sha}\"\nif [ -n \"\
        ${OP_AGENT_CHAT_SESSION:-}\" ]; then echo \"Chat session: (present)\"; else\
        \ echo \"Chat session: (empty)\"; fi\n\necho \"Invoking operation agent at\
        \ ${OP_AGENT_ENDPOINT} with run ${run_id}\"\n# Save response body and http\
        \ code for artifact upload\n/usr/bin/curl -sS -o /tmp/evoke_resp -w \"%{http_code}\"\
        \ -X POST \"${OP_AGENT_ENDPOINT%/}/evoke\" \\\n  -H \"Authorization: Bearer\
        \ ${OP_AGENT_TOKEN}\" -H \"Content-Type: application/json\" -d \"$payload\"\
        \ > /tmp/evoke_http_code || true\necho \"HTTP code: $(cat /tmp/evoke_http_code\
        \ 2>/dev/null || echo '')\"\necho \"Response (first 200 chars):\"; head -c\
        \ 200 /tmp/evoke_resp || true\n"
    - name: Save audit record
      if: always()
      run: 'echo "$(date -u) - Invoked operation agent for run ${{ github.event.workflow_run.id
        }} (workflow: ${{ github.event.workflow_run.name }})" >> $GITHUB_STEP_SUMMARY

        '
    - name: Upload evoke response artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: evoke_response_${{ github.event.workflow_run.id }}
        path: '/tmp/evoke_resp

          /tmp/evoke_http_code

          '
  selenium-e2e:
    name: Selenium E2E
    uses: ./.github/workflows/selenium-tests.yml
