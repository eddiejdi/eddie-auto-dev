name: "ðŸ’“ Homelab Health Check"

# Executa a cada 15 minutos e notifica via Telegram se algo estiver down.
# Pode tambÃ©m ser acionado manualmente.

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

env:
  API_TUNNEL_URL: "https://api.rpa4all.com"
  WEBUI_TUNNEL_URL: "https://openwebui.rpa4all.com"

# Evita mÃºltiplas execuÃ§Ãµes simultÃ¢neas
concurrency:
  group: homelab-health
  cancel-in-progress: true

jobs:
  health-check:
    name: "ðŸ’“ Health Check"
    runs-on: ubuntu-latest

    steps:
      - name: Check endpoints
        id: health
        run: |
          FAILURES=""
          DETAILS=""

          # â”€â”€ API Tunnel â”€â”€
          API_CODE=$(curl -sS -o /tmp/api_body -w '%{http_code}' \
            --max-time 15 "$API_TUNNEL_URL/agents-api/health" 2>/dev/null || echo "000")
          API_BODY=$(cat /tmp/api_body 2>/dev/null | head -c 200)
          if [[ "$API_CODE" =~ ^(200|201) ]]; then
            DETAILS="${DETAILS}âœ… API Tunnel: $API_CODE\n"
            echo "api=ok" >> "$GITHUB_OUTPUT"
          else
            FAILURES="${FAILURES}api-tunnel "
            DETAILS="${DETAILS}âŒ API Tunnel: $API_CODE ($API_BODY)\n"
            echo "api=down" >> "$GITHUB_OUTPUT"
          fi

          # â”€â”€ WebUI Tunnel â”€â”€
          WEBUI_CODE=$(curl -sS -o /dev/null -w '%{http_code}' \
            --max-time 15 "$WEBUI_TUNNEL_URL" 2>/dev/null || echo "000")
          if [[ "$WEBUI_CODE" =~ ^(200|301|302) ]]; then
            DETAILS="${DETAILS}âœ… WebUI Tunnel: $WEBUI_CODE\n"
            echo "webui=ok" >> "$GITHUB_OUTPUT"
          else
            FAILURES="${FAILURES}webui-tunnel "
            DETAILS="${DETAILS}âŒ WebUI Tunnel: $WEBUI_CODE\n"
            echo "webui=down" >> "$GITHUB_OUTPUT"
          fi

          # â”€â”€ Resultado â”€â”€
          echo "details<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$DETAILS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          if [ -n "$FAILURES" ]; then
            echo "status=unhealthy" >> "$GITHUB_OUTPUT"
            echo "failures=$FAILURES" >> "$GITHUB_OUTPUT"
          else
            echo "status=healthy" >> "$GITHUB_OUTPUT"
            echo "failures=" >> "$GITHUB_OUTPUT"
          fi

      - name: Alert via Telegram (if unhealthy)
        if: steps.health.outputs.status == 'unhealthy'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "::warning::Telegram secrets nÃ£o configurados, pulando alerta"
            exit 0
          fi

          MSG="ðŸš¨ *HOMELAB HEALTH ALERT*

          Status: UNHEALTHY
          Falhas: \`${{ steps.health.outputs.failures }}\`

          ${{ steps.health.outputs.details }}

          ðŸ”§ Para recovery:
          \`gh workflow run homelab-recovery.yml -f action=restart-services\`
          ou acesse: https://github.com/${{ github.repository }}/actions/workflows/homelab-recovery.yml"

          curl -sS "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "parse_mode=Markdown" \
            --data-urlencode "text=${MSG}" \
            --max-time 10

      - name: Auto-recovery attempt (if API tunnel down)
        if: steps.health.outputs.api == 'down' && steps.health.outputs.webui == 'ok'
        run: |
          echo "API down mas WebUI OK â€” possÃ­vel problema no specialized-agents-api"
          echo "Tentando recovery via WebUI/code-runner nÃ£o disponÃ­vel neste cenÃ¡rio."
          echo "Escalonando para next health check."

      - name: Job Summary
        run: |
          echo "## ðŸ’“ Homelab Health â€” $(date -u +'%Y-%m-%d %H:%M UTC')" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "${{ steps.health.outputs.details }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.health.outputs.status }}" = "healthy" ]; then
            echo "**Status: âœ… HEALTHY**" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "**Status: âŒ UNHEALTHY** â€” Falhas: \`${{ steps.health.outputs.failures }}\`" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Fail if unhealthy
        if: steps.health.outputs.status == 'unhealthy'
        run: |
          echo "::error::Homelab unhealthy: ${{ steps.health.outputs.failures }}"
          exit 1
