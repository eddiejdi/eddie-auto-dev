name: Agent Responder Integration Test
on:
  pull_request:
    branches:
    - main
  workflow_dispatch: null
jobs:
  responder-integration:
    runs-on:
    - self-hosted
    - linux
    - homelab
    steps:
    - uses: actions/checkout@v4
    - name: Ensure jq installed
      run: "if ! command -v jq >/dev/null; then\n  sudo apt-get update && sudo apt-get\
        \ install -y jq\nfi\n"
    - name: Check in-process responder (pre-check)
      env:
        API_URL: http://127.0.0.1:8503
      run: "set -euo pipefail\necho \"Checking in-process responder via $API_URL/communication/test\"\
        \n# Attempt to start responder in-process and wait briefly; expect at least\
        \ one local response\nif curl -sS -X POST \"$API_URL/communication/test\"\
        \ -H 'Content-Type: application/json' -d '{\"message\":\"please_respond\"\
        ,\"start_responder\":true,\"wait_seconds\":1.0}' | jq -e '.local_responses_count\
        \ and (.local_responses_count > 0)'; then\n  echo \"In-process responder check\
        \ OK\"\nelse\n  echo \"In-process responder not active in this API process\
        \ (failing early)\" >&2\n  echo \"Dumping subscribers and recent messages\
        \ for debugging...\" >&2\n  curl -sS \"$API_URL/debug/communication/subscribers\"\
        \ || true\n  curl -sS \"$API_URL/communication/messages?limit=50\" | jq '.messages\
        \ | length' || true\n  # show the temporary responder log if present\n  test\
        \ -f /tmp/responder.log && cat /tmp/responder.log || true\n  exit 1\nfi\n"
    - name: Run agent responder integration script
      env:
        API_URL: http://127.0.0.1:8503
      run: "set -euo pipefail\necho \"Running responder integration test against $API_URL\"\
        \nbash scripts/test_agent_responder.sh | tee /tmp/responder.log\n"
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: responder-log
        path: /tmp/responder.log
  selenium-e2e:
    name: Selenium E2E
    uses: ./.github/workflows/selenium-tests.yml
