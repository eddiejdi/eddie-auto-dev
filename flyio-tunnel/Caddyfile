# Caddyfile - Proxy reverso para homelab
# Open WebUI na raiz para funcionar corretamente no mobile
{
    admin off
    auto_https off
}

:8080 {
    # Health check endpoint
    handle /health {
        respond "OK" 200
    }

    # Ollama API nativa (via /api/ollama)
    handle_path /api/ollama/* {
        reverse_proxy {$HOMELAB_HOST}:{$OLLAMA_PORT} {
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            transport http {
                dial_timeout 30s
                response_header_timeout 120s
            }
        }
    }
    
    # Rota espec√≠fica para /api/ollama sem trailing slash
    handle_path /api/ollama {
        rewrite * /
        reverse_proxy {$HOMELAB_HOST}:{$OLLAMA_PORT} {
            header_up Host {upstream_hostport}
            transport http {
                dial_timeout 30s
                response_header_timeout 120s
            }
        }
    }

    # RAG Dashboard
    handle_path /rag/* {
        reverse_proxy {$HOMELAB_HOST}:{$RAG_DASHBOARD_PORT} {
            header_up Host {upstream_hostport}
            header_up X-Forwarded-Prefix /rag
        }
    }

    # GitHub Agent
    handle_path /github/* {
        reverse_proxy {$HOMELAB_HOST}:{$GITHUB_AGENT_PORT} {
            header_up Host {upstream_hostport}
            header_up X-Forwarded-Prefix /github
        }
    }

    # RAG API
    handle_path /api/rag/* {
        reverse_proxy {$HOMELAB_HOST}:{$RAG_API_PORT} {
            header_up Host {upstream_hostport}
        }
    }

    # Open WebUI - na raiz para funcionar com todos os assets
    # Isso inclui /static/*, /api/*, /v1/*, etc do WebUI
    handle {
        reverse_proxy {$HOMELAB_HOST}:{$WEBUI_PORT} {
            # Manter o Host original do Fly.io para OAuth funcionar
            header_up Host homelab-tunnel-sparkling-sun-3565.fly.dev
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Host homelab-tunnel-sparkling-sun-3565.fly.dev
            header_up X-Forwarded-Port 443
            transport http {
                dial_timeout 30s
                response_header_timeout 300s
            }
        }
    }
}
