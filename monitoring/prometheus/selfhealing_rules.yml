groups:
  - name: selfhealing_alerts
    interval: 30s
    rules:
      # Detecta travamento (stall > 300s)
      - alert: ServiceStalled
        expr: |
          (time() - process_start_time_seconds) > 300 
          and on() group_left 
          rate(process_runtime_go_goroutines[1m]) < 0.1
        for: 2m
        labels:
          severity: critical
          action: selfheal
        annotations:
          summary: "Servi√ßo {{ $labels.job }} travado por > 300s"
          description: "O servi√ßo {{ $labels.job }} n√£o est√° respondendo. Self-healing ser√° acionado em {{ $value }}s"
          action: "curl -s http://localhost:9100/api/selfheal/restart?job={{ $labels.job }}"

      # Monitora restarts consecutivos (runaway)
      - alert: SelfHealingExhausted
        expr: |
          increase(selfhealing_restarts_total[1h]) > 3
        for: 1m
        labels:
          severity: warning
          action: notify
        annotations:
          summary: "{{ $labels.job }} reiniciou {{ $value }} vezes em 1h"
          description: "Limite de 3 restarts/hora atingido. Verifica√ß√£o manual recomendada."

      # S√©rie de falhas consecutivas
      - alert: ConsecutiveFailures
        expr: |
          selfhealing_consecutive_failures > 2
        for: 3m
        labels:
          severity: critical
          action: escalate
        annotations:
          summary: "{{ $labels.job }} com {{ $value }} falhas consecutivas"
          description: "O servi√ßo continua falhando ap√≥s selfhealing. Escalando para admin."

      # M√©trica agregada de sa√∫de
      - record: selfhealing:service_health:ratio
        expr: |
          count(up{job=~"crypto-agent|jira-worker"} == 1) 
          / 
          count(up{job=~"crypto-agent|jira-worker"})

      # Status de stall para cada servi√ßo
      - record: selfhealing:stall_duration:seconds
        expr: |
          max by (job) (
            (time() - process_start_time_seconds) > 0
          )

  - name: ollama_selfhealing
    interval: 30s
    rules:
      # Detecta congelamento do Ollama: sem requisi√ß√µes por > 60s OU GPU em 0% por > 180s
      - alert: OllamaFrozen
        expr: |
          (
            # Sem requisi√ß√µes por 60s
            (time() - ollama_last_request_timestamp > 60)
            and 
            # E a GPU n√£o est√° processando por 180s
            (max(ollama_gpu_utilization{job="ollama"}) < 1 for 3m)
          )
          or
          (
            # OU Ollama reporta goroutines/threads presos
            ollama_frozen_goroutines > 50
          )
        for: 2m
        labels:
          severity: critical
          action: selfheal
          service: ollama
        annotations:
          summary: "üî¥ Ollama congelado (frozen > 120s)"
          description: "Ollama n√£o responde h√° {{ $value }}s. Sem requisi√ß√µes e GPU inativa. Auto-restart em progresso..."
          action: "systemctl restart ollama"
          runbook: "https://grafana.rpa4all.com/d/ollama-monitoring"

      # Detec√ß√£o de resposta lenta (timeout)
      - alert: OllamaSlowResponse
        expr: |
          histogram_quantile(0.95, rate(ollama_request_duration_seconds_bucket[5m])) > 30
        for: 3m
        labels:
          severity: warning
          action: notify
        annotations:
          summary: "Ollama respondendo lentamente (p95: {{ $value }}s)"
          description: "95¬∫ percentil de lat√™ncia > 30s. Poss√≠vel CPU travado ou mem√≥ria insuficiente."

      # Memory pressure (evita crescimento descontrolado)
      - alert: OllamaMemoryPressure
        expr: |
          (ollama_memory_used_bytes / ollama_memory_max_bytes) > 0.95
        for: 2m
        labels:
          severity: warning
          action: notify
        annotations:
          summary: "Ollama mem√≥ria em {{ $value | humanizePercentage }}"
          description: "Mem√≥ria GPU/CPU ocupada. Modelo grande demais ou memory leak."

      # GPU fan/temperatura cr√≠tica
      - alert: OllamaGPUOverheat
        expr: |
          nvidia_smi_temperature{uuid=~".*"} > 85
        for: 2m
        labels:
          severity: warning
          action: throttle
        annotations:
          summary: "GPU em {{ $value }}¬∞C (limite: 85)"
          description: "Temperatura cr√≠tica detectada. Reduzindo contexto window para evitar damage."

      # M√©trica: √∫ltimo heartbeat (para detectar congelamento)
      - record: ollama:frozen_duration:seconds
        expr: |
          time() - ollama_last_request_timestamp

      # M√©trica: sa√∫de agregada
      - record: ollama:health:status
        expr: |
          (ollama_up == 1) and (ollama_gpu_utilization > 0) * 1
          or
          (ollama_up == 1) and (time() - ollama_last_request_timestamp < 120) * 0.5
          or 0

      # M√©trica: efici√™ncia de processamento
      - record: ollama:performance:ratio
        expr: |
          rate(ollama_tokens_generated[5m]) / (rate(ollama_request_duration_seconds_sum[5m]) + 1)

