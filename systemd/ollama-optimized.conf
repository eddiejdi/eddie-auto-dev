[Unit]
After=network-online.target basic.target

[Service]
CPUAffinity=2-15
Type=simple
Restart=always
RestartSec=5

# THREAD DISTRIBUTION
Environment=GGML_NUM_THREADS=10
Environment=OLLAMA_NUM_THREADS=10
Environment=OMP_NUM_THREADS=10
Environment=OMP_THREAD_LIMIT=14
Environment=MKL_NUM_THREADS=10
Environment=OPENBLAS_NUM_THREADS=10
Environment=OMP_PROC_BIND=spread
Environment=OMP_PLACES=threads
Environment=GOMP_CPU_AFFINITY=2-15
Environment=GOMAXPROCS=6

# DUAL GPU MODE (RTX 2060 SUPER 8GB + GTX 1050 2GB)
Environment=OLLAMA_NUM_GPU=999
Environment=CUDA_VISIBLE_DEVICES=0,1
Environment=OLLAMA_HOST=0.0.0.0:11434
Environment=OLLAMA_LOAD_TIMEOUT=15m
Environment=OLLAMA_KEEP_ALIVE=30m

# SPREAD + overhead de 500MB por GPU
# GPU0: 7.6GB - 500MB = 7.1GB disponivel (cabe ~22 layers + KV)
# GPU1: 1.9GB - 500MB = 1.4GB disponivel (cabe ~7 layers)
# Total GPU: ~29 layers = modelo inteiro em dual-GPU
Environment=OLLAMA_SCHED_SPREAD=true
Environment=OLLAMA_GPU_OVERHEAD=536870912

# KV + paralelismo
Environment=OLLAMA_KV_CACHE_TYPE=q4_0
Environment=OLLAMA_FLASH_ATTENTION=true
Environment=OLLAMA_NUM_PARALLEL=1
Environment=OLLAMA_MAX_LOADED_MODELS=1

ExecStart=
ExecStart=/usr/local/bin/ollama serve
