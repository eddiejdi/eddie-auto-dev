[Unit]
After=network-online.target basic.target

[Service]
CPUAffinity=2-15
Type=simple
Restart=always
RestartSec=5

# THREAD DISTRIBUTION
Environment=GGML_NUM_THREADS=10
Environment=OLLAMA_NUM_THREADS=10
Environment=OMP_NUM_THREADS=10
Environment=OMP_THREAD_LIMIT=14
Environment=MKL_NUM_THREADS=10
Environment=OPENBLAS_NUM_THREADS=10
Environment=OMP_PROC_BIND=spread
Environment=OMP_PLACES=threads
Environment=GOMP_CPU_AFFINITY=2-15
Environment=GOMAXPROCS=6

# SINGLE GPU MODE — GPU0 only (RTX 2060 SUPER 8GB)
# GPU1 (GTX 1050 2GB) é gerenciada pelo ollama-small.service separado
Environment=OLLAMA_NUM_GPU=999
Environment=CUDA_VISIBLE_DEVICES=0
Environment=OLLAMA_HOST=0.0.0.0:11434
Environment=OLLAMA_LOAD_TIMEOUT=15m
Environment=OLLAMA_KEEP_ALIVE=30m

# GPU0 dedicada — sem spread (cada instância tem sua GPU)
Environment=OLLAMA_SCHED_SPREAD=false
Environment=OLLAMA_GPU_OVERHEAD=536870912

# KV + paralelismo
Environment=OLLAMA_KV_CACHE_TYPE=q4_0
Environment=OLLAMA_FLASH_ATTENTION=true
Environment=OLLAMA_NUM_PARALLEL=1
Environment=OLLAMA_MAX_LOADED_MODELS=1

ExecStart=
ExecStart=/usr/local/bin/ollama serve
