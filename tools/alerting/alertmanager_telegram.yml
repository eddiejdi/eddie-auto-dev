# Alertmanager Configuration for Prometheus
# Integração com Telegram para notificações de Self-Healing

global:
  resolve_timeout: 5m
  # Telegram webhook (usando Python webhook receiver)
  telegram_api_url: 'https://api.telegram.org/bot'

# Templates for alert messages
templates:
  - '/etc/prometheus/alertmanager_templates/*.tmpl'

# Main route configuration
route:
  receiver: 'default'
  group_by: ['alertname', 'cluster', 'service', 'job']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 3h

  # Route for self-healing alerts → Telegram
  routes:
    # Ollama Self-Healing Alerts
    - matchers:
        - alertname=~"OllamaFrozen|OllamaSlowResponse|OllamaMemoryPressure|SelfHealingExhausted"
      receiver: 'telegram-selfhealing'
      group_by: ['alertname', 'severity']
      group_wait: 10s  # Faster notification for critical alerts
      group_interval: 5m
      repeat_interval: 1h
      continue: true  # Also send to default receiver

    # Service Self-Healing Alerts
    - matchers:
        - alertname=~"ServiceStalled|SelfHealingRestarted|ConsecutiveFailures"
      receiver: 'telegram-selfhealing'
      group_by: ['alertname', 'job', 'severity']
      group_wait: 15s
      group_interval: 5m
      repeat_interval: 1h

    # Critical alerts (always notify)
    - matchers:
        - severity="critical"
      receiver: 'telegram-critical'
      group_wait: 10s
      group_interval: 5m
      repeat_interval: 30m

# Receivers configuration
receivers:
  # Default receiver (discarded if no match)
  - name: 'default'

  # Telegram for Self-Healing alerts
  - name: 'telegram-selfhealing'
    webhook_configs:
      - url: 'http://localhost:5000/alerts'
        send_resolved: true
        headers:
          X-Alert-Type: 'self-healing'

  # Telegram for Critical alerts
  - name: 'telegram-critical'
    webhook_configs:
      - url: 'http://localhost:5000/alerts'
        send_resolved: true
        headers:
          X-Alert-Type: 'critical'

# Inhibition rules
inhibit_rules:
  # Mute warnings if critical alert firing
  - source_matchers: 
      - severity="critical"
    target_matchers: 
      - severity="warning"
    equal: [alertname, cluster, service, job]
